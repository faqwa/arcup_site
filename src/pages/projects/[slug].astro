---
// ============================================================================
// FILE: src/pages/projects/[slug].astro
// ACTION: FULL REPLACEMENT
// CHANGES:
// 1. Added conditional rendering for timeline, contributions, and resources
// 2. Using SectionHeader component for consistency
// 3. Better empty states for resources section
// 4. Cleaner structure with optional sections
// ============================================================================
import { getCollection } from 'astro:content';
import BaseLayout from "../../layouts/BaseLayout.astro";
import ArcCanvas from "../../components/ArcCanvas.astro";
import PageNavigation from "../../components/PageNavigation.astro";
import Card from "../../components/Card.astro";
import LinkButton from "../../components/LinkButton.astro";
import StatusBadge from "../../components/StatusBadge.astro";
import SectionHeader from "../../components/SectionHeader.astro";
import CalloutPanel from "../../components/CalloutPanel.astro";

import '../../styles/pages/project-detail.css';

import { withBase } from '../../utils/paths';
import { buildSEO } from '../../utils/seo';
import { EXTERNAL_LINKS } from '../../config/constants';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await project.render();

const seo = buildSEO({
  title: project.data.title,
  description: project.data.description,
  path: `/projects/${project.slug}`,
  siteUrl: Astro.site,
});

// Check if optional sections have content
const hasTimeline = project.data.timeline && project.data.timeline.length > 0;
const hasContributions = project.data.contributions && project.data.contributions.length > 0;
const hasLinks = project.data.links && project.data.links.length > 0;
---

<BaseLayout
  title={seo.title}
  description={seo.description}
  bodyClass="page-project-detail"
  seo={seo}
  navActive="projects"
>
  <ArcCanvas slot="before-header" />

  <main id="main-content" class="page-shell project-detail-shell">
    
    <!-- BREADCRUMB -->
    <nav class="breadcrumb" aria-label="Breadcrumb">
      <a href={withBase("/projects")}>Projects</a>
      <span aria-hidden="true">/</span>
      <span aria-current="page">{project.data.title}</span>
    </nav>

    <!-- PROJECT HERO -->
    <header class="project-hero">
      <div class="project-meta">
        <StatusBadge status={project.data.status} />
        <span class="project-date">Last updated: {project.data.lastUpdated}</span>
      </div>
      <h1>{project.data.title}</h1>
      <p class="project-lede">{project.data.description}</p>
    </header>

    <!-- QUICK SUMMARY PANEL -->
    <!-- COMMENTED OUT FOR NOW - Keeping this for future use!
         This "At a Glance" table provides a nice quick summary.
         Uncomment when projects have enough data to populate it meaningfully.
    
    <Card as="section" class="summary-panel">
      <SectionHeader 
        title="At a Glance"
        align="center"
        headingLevel="h2"
      />
      <div class="summary-grid">
        <div class="summary-item">
          <h3>The Challenge</h3>
          <p>{project.data.challenge}</p>
        </div>
        <div class="summary-item">
          <h3>Our Approach</h3>
          <p>{project.data.approach}</p>
        </div>
        <div class="summary-item">
          <h3>Current Status</h3>
          <p>{project.data.currentStatus}</p>
        </div>
      </div>
    </Card>
    -->

    <!-- MAIN CONTENT -->
    <article class="project-content">
      
      <!-- Project Description (from markdown) -->
      <section class="content-section">
        <Content />
      </section>

      <!-- Research Questions -->
      <section class="content-section">
        <SectionHeader 
          title="Research Questions"
          align="left"
          headingLevel="h2"
        />
        <ul class="styled-list">
          {project.data.researchQuestions.map((question) => (
            <li>{question}</li>
          ))}
        </ul>
      </section>

      <!-- What We're Looking For -->
      <section class="content-section">
        <SectionHeader 
          title="What We're Looking For"
          align="left"
          headingLevel="h2"
        />
        <div class="needs-grid">
          <div class="need-item">
            <h3>Expertise</h3>
            <ul>
              {project.data.expertise.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </div>
          <div class="need-item">
            <h3>Resources</h3>
            <ul>
              {project.data.resources.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </div>
          <div class="need-item">
            <h3>Support</h3>
            <ul>
              {project.data.support.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </div>
        </div>
      </section>

      <!-- Project Timeline (CONDITIONAL) -->
      {hasTimeline && (
        <section class="content-section">
          <SectionHeader 
            title="Project Timeline"
            align="left"
            headingLevel="h2"
          />
          <div class="timeline">
            {project.data.timeline.map((phase) => (
              <div class="timeline-item">
                <div class="timeline-marker">
                  <span class="timeline-date">{phase.date}</span>
                </div>
                <div class="timeline-content">
                  <h3>{phase.phase}</h3>
                  <p>{phase.description}</p>
                </div>
              </div>
            ))}
          </div>
        </section>
      )}

      <!-- How to Contribute (CONDITIONAL) -->
      {hasContributions && (
        <section class="content-section">
          <SectionHeader 
            title="How to Contribute"
            subtitle="There are multiple ways to get involved, regardless of your background."
            align="left"
            headingLevel="h2"
          />
          <div class="contribution-cards">
            {project.data.contributions.map((contrib) => (
              <div class="contrib-card">
                <h3>{contrib.title}</h3>
                <p>{contrib.description}</p>
              </div>
            ))}
          </div>
        </section>
      )}

    </article>

    <!-- LINKS & RESOURCES -->
    <Card as="section" class="resources-section">
      <SectionHeader 
        title="Links & Resources"
        align="center"
        headingLevel="h2"
      />
      
      {hasLinks ? (
        <>
          <p class="resources-intro">As this project develops, we'll share documentation, data, and code here. Everything stays open.</p>
          <div class="links-grid">
            {project.data.links.map((link) => (
              <a 
                href={link.url || '#'} 
                class={`resource-link ${link.status === 'coming-soon' ? 'disabled' : ''}`}
                aria-disabled={link.status === 'coming-soon'}
              >
                <span class="link-icon">{link.icon}</span>
                <div class="link-content">
                  <h3>{link.title}</h3>
                  <p>{link.description}</p>
                </div>
                {link.status === 'coming-soon' && (
                  <span class="link-status">Coming Soon</span>
                )}
              </a>
            ))}
          </div>
        </>
      ) : (
        <CalloutPanel variant="info">
          <p>
            <strong>Documentation in progress.</strong> This project is in early stages. 
            As we develop hypotheses, run experiments, and document findings, we'll share 
            everything here — data, code, CAD files, and learnings.
          </p>
          <p style="margin-bottom: 0;">
            Want to help shape what gets shared first? <a href={EXTERNAL_LINKS.formURL}>Get involved</a>.
          </p>
        </CalloutPanel>
      )}
    </Card>

    <!-- JOIN CTA -->
    <Card as="section" class="join-cta-section">
      <SectionHeader 
        title="Join This Project"
        subtitle="The project is in early stages, which means you can help shape the direction."
        align="center"
        headingLevel="h2"
      />
      <div class="cta-buttons">
        <LinkButton href={EXTERNAL_LINKS.formURL} variant="primary" icon="external">
          Get Involved
        </LinkButton>
        <LinkButton href={withBase("/projects")} variant="outline" icon="arrow-right">
          ← Back to All Projects
        </LinkButton>
      </div>
    </Card>

  </main>

  <PageNavigation currentPage="projects" />
</BaseLayout>